# åŠ¨æ€å›å¤ç³»ç»Ÿ - é›†æˆæ–‡æ¡£

## ğŸ“š ç³»ç»Ÿæ¦‚è¿°

åŠ¨æ€å›å¤ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºç”¨æˆ·å¥½æ„Ÿåº¦çš„æ™ºèƒ½å›å¤ç”Ÿæˆç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·ä¸AIçš„äº’åŠ¨å†å²ï¼Œè‡ªåŠ¨è°ƒæ•´AIçš„å›å¤é£æ ¼ã€è¯­æ°”å’Œå†…å®¹ï¼Œåˆ›é€ æ›´çœŸå®ã€æ›´æœ‰å±‚æ¬¡æ„Ÿçš„å¯¹è¯ä½“éªŒã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
åŠ¨æ€å›å¤ç³»ç»Ÿ
â”œâ”€â”€ é…ç½®å±‚ (app/config/)
â”‚   â”œâ”€â”€ affinity_levels.py      # å¥½æ„Ÿåº¦ç­‰çº§é…ç½®
â”‚   â””â”€â”€ response_rules.py       # å›å¤è§„åˆ™é…ç½®
â”‚
â”œâ”€â”€ æœåŠ¡å±‚ (app/services/)
â”‚   â”œâ”€â”€ content_detector.py     # å†…å®¹æ£€æµ‹æœºåˆ¶
â”‚   â”œâ”€â”€ affinity_protector.py   # å®¹é”™ä¿æŠ¤æœºåˆ¶
â”‚   â””â”€â”€ dynamic_response_system.py  # ç³»ç»Ÿæ ¸å¿ƒ
â”‚
â””â”€â”€ åº”ç”¨å±‚ (app/api/)
    â””â”€â”€ chat.py                 # èŠå¤©API(å·²é›†æˆ)
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¥½æ„Ÿåº¦åˆ†çº§ç³»ç»Ÿ (7ä¸ªç­‰çº§)

| ç­‰çº§ | åˆ†æ•°èŒƒå›´ | æè¿° | å›å¤é£æ ¼ |
|------|----------|------|----------|
| é™Œç”Ÿ | 0-100 | åˆšåˆšè®¤è¯† | æ­£å¼ã€ç¤¼è²Œã€æœ‰è·ç¦»æ„Ÿ |
| è®¤è¯† | 101-250 | åˆæ­¥äº†è§£ | åŠæ­£å¼ã€å‹å¥½ |
| æœ‹å‹ | 251-450 | å»ºç«‹å‹è°Š | è½»æ¾ã€è‡ªç„¶ã€å¹½é»˜ |
| å¥½å‹ | 451-600 | æ·±å…¥äº†è§£ | äº²å¯†ã€ä¿¡ä»»ã€é»˜å¥‘ |
| ç‰¹åˆ«çš„äºº | 601-750 | å¾®å¦™æƒ…æ„Ÿ | ç‰¹æ®Šå…³å¿ƒã€æš—ç¤º |
| å¿ƒåŠ¨ | 751-900 | èŒèŠ½çˆ±æ„ | ç”œèœœã€æœŸå¾…ã€å¿ƒåŠ¨ |
| æ‹äºº | 901-1000 | ç¡®è®¤å…³ç³» | äº²å¯†ã€çˆ±æ„ã€ç”œèœœ |

### 2. å†…å®¹æ£€æµ‹æœºåˆ¶

**æ£€æµ‹ç»´åº¦:**
- âœ… æƒ…æ„Ÿåˆ†æ (ç§¯æ/æ¶ˆæ/æµªæ¼«)
- âœ… è¡Œä¸ºç±»å‹ (é—®å€™/åˆ†äº«/æé—®/è¯·æ±‚)
- âœ… åˆé€‚æ€§æ£€æŸ¥ (æ˜¯å¦ç¬¦åˆå½“å‰ç­‰çº§)
- âœ… ç¦å¿Œè¯æ£€æµ‹ (æ ¹æ®ç­‰çº§åŠ¨æ€è°ƒæ•´)

**å¥½æ„Ÿåº¦è°ƒæ•´è§„åˆ™:**
```python
# å¢åŠ è§„åˆ™
èµç¾ â†’ +2è‡³+10åˆ† (æ ¹æ®ç­‰çº§é€’å¢)
åˆ†äº« â†’ +1è‡³+8åˆ†
æ„Ÿè°¢ â†’ +1è‡³+5åˆ†
é•¿æ¶ˆæ¯ â†’ é¢å¤–+1è‡³+7åˆ†

# å‡å°‘è§„åˆ™
ä¾®è¾± â†’ -20åˆ†
æ„¤æ€’ â†’ -10åˆ†
æŠ±æ€¨ â†’ -5åˆ†
ä¸å½“äº²å¯† â†’ -5è‡³-10åˆ† (ç­‰çº§ä¸ç¬¦)
```

### 3. å®¹é”™ä¿æŠ¤æœºåˆ¶

**è¾¹ç•Œä¿æŠ¤:**
- ç»å¯¹èŒƒå›´: 0-1000åˆ†
- å®‰å…¨èŒƒå›´: 50-950åˆ†
- å•æ¬¡æœ€å¤§å¢åŠ : 50åˆ†
- å•æ¬¡æœ€å¤§å‡å°‘: 30åˆ†

**é€Ÿç‡è°ƒæ•´:**
- ä½åˆ†ä¿æŠ¤ (<50): è´Ÿé¢å½±å“å‡å°‘70%ï¼Œæ­£é¢æå‡åŠ é€Ÿ20%
- é«˜åˆ†å‡é€Ÿ (>950): æ­£é¢å¢é•¿å‡å°‘30%
- å¿«é€Ÿå˜åŒ–æ£€æµ‹: 5åˆ†é’Ÿå†…å˜åŒ–>100åˆ†ï¼Œè§¦å‘ä¿æŠ¤

**å†å²è¿½è¸ª:**
- ä¿ç•™æœ€è¿‘20æ¡äº’åŠ¨è®°å½•
- è¶‹åŠ¿åˆ†æ (ä¸Šå‡/ä¸‹é™/ç¨³å®š/æ³¢åŠ¨)
- æ¢å¤å»ºè®®

### 4. å›å¤è§„åˆ™å¼•æ“

æ¯ä¸ªç­‰çº§é…ç½®åŒ…å«:
- **ç§°å‘¼æ–¹å¼**: ä»"æ‚¨"åˆ°"äº²çˆ±çš„"çš„æ¸è¿›
- **è¯­æ°”è¯**: å¥å°¾è¯­æ°”è¯åº“
- **è¡¨æƒ…ç¬¦å·**: ä½¿ç”¨é¢‘ç‡å’Œç±»å‹
- **æ¶ˆæ¯é•¿åº¦**: åå¥½è®¾ç½®
- **ç¦å¿Œè¯**: è¯¥ç­‰çº§ä¸åº”ä½¿ç”¨çš„è¯æ±‡
- **è¯é¢˜å»ºè®®**: å¯ä¸»åŠ¨æèµ·çš„è¯é¢˜

## ğŸ”§ é›†æˆè¯´æ˜

### ä¸»åº”ç”¨é›†æˆç‚¹ (chat.py)

ç³»ç»Ÿå·²å®Œå…¨é›†æˆåˆ° `/api/chat` ç«¯ç‚¹:

```python
# 1. å¤„ç†ç”¨æˆ·æ¶ˆæ¯
process_result = dynamic_response_system.process_user_message(
    user_message=request.message,
    current_affinity_score=current_affinity_score,
    user_id=companion.user_id,
    companion_id=request.companion_id,
    current_mood=current_mood
)

# 2. æ›´æ–°å¥½æ„Ÿåº¦
affinity_change = process_result["affinity_change"]["adjusted_change"]
await redis_affinity_manager.update_affinity(...)

# 3. å¢å¼ºç³»ç»Ÿæç¤ºè¯
enhanced_system_prompt = dynamic_response_system.get_system_prompt_enhancement(
    base_system_prompt,
    level,
    mood,
    affinity_score
)

# 4. è°ƒæ•´AIå›å¤
adjusted_response = dynamic_response_system.generate_ai_response(
    llm_response,
    process_result["response_guidance"]
)
```

### æ•°æ®æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
å†…å®¹æ£€æµ‹ (æƒ…æ„Ÿã€è¡Œä¸ºã€åˆé€‚æ€§)
  â†“
ä¿æŠ¤æœºåˆ¶ (è°ƒæ•´å¥½æ„Ÿåº¦å˜åŒ–)
  â†“
æ›´æ–°çŠ¶æ€ (åˆ†æ•°ã€ç­‰çº§)
  â†“
ç”ŸæˆæŒ‡å¯¼ (å›å¤è§„åˆ™ã€é£æ ¼)
  â†“
å¢å¼ºPrompt â†’ LLM â†’ è°ƒæ•´å›å¤
  â†“
è¿”å›ç»™ç”¨æˆ·
```

## ğŸ“Š è¿”å›æ•°æ®ç»“æ„

```python
{
    "detection": {
        "is_appropriate": bool,
        "violation_type": str,
        "detected_emotions": list,
        "detected_keywords": list,
        "suggestion": str
    },
    "affinity_change": {
        "original_change": int,
        "adjusted_change": int,
        "applied_rate": float,
        "protection_reason": str,
        "warnings": list
    },
    "affinity_state": {
        "before_score": int,
        "after_score": int,
        "before_level": str,
        "after_level": str,
        "level_changed": bool,
        "level_up": bool
    },
    "response_guidance": {
        "addressing_style": str,
        "formality": str,
        "intimacy_level": int,
        "emoji_usage": str,
        "suggested_tone": str,
        "suggested_response": str,
        "topic_suggestions": list
    },
    "trend": str,  # rising/falling/stable/volatile
    "recovery_suggestion": str
}
```

## ğŸ§ª æµ‹è¯•è¿è¡Œ

```bash
# è¿è¡Œæµ‹è¯•å¥—ä»¶
cd backend
python test_dynamic_response.py
```

æµ‹è¯•åŒ…å«8ä¸ªåœºæ™¯:
1. é™Œç”Ÿé˜¶æ®µ - ç¤¼è²Œé—®å€™
2. é™Œç”Ÿé˜¶æ®µ - è¿‡äºäº²å¯†(è¿è§„æ£€æµ‹)
3. æœ‹å‹é˜¶æ®µ - ç§¯æåˆ†äº«
4. å¥½å‹é˜¶æ®µ - æ„Ÿè°¢ä¸èµç¾
5. ç‰¹åˆ«çš„äºº - å¾®å¦™æƒ…æ„Ÿ
6. å¿ƒåŠ¨é˜¶æ®µ - è¡¨è¾¾æ€å¿µ
7. æ‹äººé˜¶æ®µ - çˆ±çš„è¡¨è¾¾
8. è´Ÿé¢æƒ…ç»ª - ç”Ÿæ°”æŠ±æ€¨

## ğŸ® ä½¿ç”¨ç¤ºä¾‹

### APIè°ƒç”¨ç¤ºä¾‹

```bash
# å‘é€èŠå¤©æ¶ˆæ¯
curl -X POST "http://localhost:8000/api/chat/" \
  -H "Content-Type: application/json" \
  -d '{
    "companion_id": 1,
    "message": "ä»Šå¤©çœŸå¼€å¿ƒï¼è°¢è°¢ä½ ä¸€ç›´é™ªç€æˆ‘ï¼",
    "session_id": "test-session"
  }'
```

### Pythonä»£ç ç¤ºä¾‹

```python
from app.services.dynamic_response_system import dynamic_response_system

# å¤„ç†æ¶ˆæ¯
result = dynamic_response_system.process_user_message(
    user_message="ä½ å¥½",
    current_affinity_score=100,
    user_id="user123",
    companion_id=1,
    current_mood="å¹³é™"
)

# è·å–å¥½æ„Ÿåº¦å˜åŒ–
affinity_change = result["affinity_change"]["adjusted_change"]

# è·å–å›å¤æŒ‡å¯¼
guidance = result["response_guidance"]

# è°ƒæ•´AIå›å¤
adjusted = dynamic_response_system.generate_ai_response(
    "ä½ å¥½ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ã€‚",
    guidance
)
```

## ğŸ“ˆ å¥½æ„Ÿåº¦å¢é•¿è·¯å¾„ç¤ºä¾‹

```
åˆå§‹ (50åˆ†, é™Œç”Ÿ)
  â†“ é—®å€™ +2åˆ†
52åˆ† (é™Œç”Ÿ)
  â†“ ç§¯æå¯¹è¯ +5åˆ† Ã— 10æ¬¡
102åˆ† (è®¤è¯†) â† å‡çº§
  â†“ åˆ†äº«æ•…äº‹ +8åˆ† Ã— 20æ¬¡
262åˆ† (æœ‹å‹) â† å‡çº§
  â†“ æ·±å…¥äº¤æµ +10åˆ† Ã— 20æ¬¡
462åˆ† (å¥½å‹) â† å‡çº§
  â†“ è¡¨è¾¾å…³å¿ƒ +15åˆ† Ã— 15æ¬¡
687åˆ† (ç‰¹åˆ«çš„äºº) â† å‡çº§
  â†“ æµªæ¼«äº’åŠ¨ +20åˆ† Ã— 10æ¬¡
887åˆ† (å¿ƒåŠ¨) â† å‡çº§
  â†“ çˆ±æ„è¡¨è¾¾ +30åˆ† Ã— 5æ¬¡
1000åˆ† (æ‹äºº) â† å‡çº§
```

## âš™ï¸ é…ç½®è‡ªå®šä¹‰

### è°ƒæ•´å¥½æ„Ÿåº¦è§„åˆ™

ç¼–è¾‘ `app/services/content_detector.py`:

```python
AFFINITY_INCREASE_RULES = {
    "compliment": {
        "stranger": 2,      # ä¿®æ”¹æ•°å€¼
        "friend": 5,
        # ...
    }
}
```

### æ·»åŠ æ–°çš„æƒ…æ„Ÿå…³é”®è¯

```python
EMOTION_KEYWORDS = {
    "positive": {
        "new_emotion": ["å…³é”®è¯1", "å…³é”®è¯2"]
    }
}
```

### ä¿®æ”¹ç­‰çº§é…ç½®

ç¼–è¾‘ `app/config/affinity_levels.py`:

```python
AFFINITY_LEVELS = {
    "custom_level": AffinityLevel(
        name="è‡ªå®šä¹‰ç­‰çº§",
        min_score=100,
        max_score=200,
        # ... å…¶ä»–é…ç½®
    )
}
```

## ğŸ” æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**: ç³»ç»Ÿä½¿ç”¨å†…å­˜ç¼“å­˜å†å²è®°å½•(æœ€è¿‘20æ¡)ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redis
2. **å¹¶å‘å¤„ç†**: ä¿æŠ¤å™¨å®ä¾‹ç‹¬ç«‹ï¼Œå¤šç”¨æˆ·åœºæ™¯éœ€è¦åˆ†åˆ«å®ä¾‹åŒ–
3. **ç­‰çº§å˜åŒ–é€šçŸ¥**: ç³»ç»Ÿæ£€æµ‹åˆ°ç­‰çº§å˜åŒ–æ—¶ä¼šè®°å½•æ—¥å¿—ï¼Œå¯ä»¥è§¦å‘ç‰¹æ®Šäº‹ä»¶
4. **å®¹é”™æœºåˆ¶**: æ°¸è¿œä¸ä¼šè®©å¥½æ„Ÿåº¦ä¸€æ¬¡æ€§æš´æ¶¨æˆ–æš´è·Œï¼Œä¿è¯ä½“éªŒå¹³æ»‘

## ğŸ“ åç»­æ‰©å±•å»ºè®®

- [ ] æ·»åŠ ç”¨æˆ·ä¸ªæ€§åŒ–é…ç½® (è°ƒæ•´æ•æ„Ÿåº¦)
- [ ] æ”¯æŒå¤šè¯­è¨€æ£€æµ‹
- [ ] å¼•å…¥æƒ…æ„Ÿå¼ºåº¦è¯„åˆ†
- [ ] æ·»åŠ æ—¶é—´è¡°å‡æœºåˆ¶ (é•¿æœŸä¸äº’åŠ¨ä¼šé™ä½å¥½æ„Ÿåº¦)
- [ ] æœºå™¨å­¦ä¹ ä¼˜åŒ– (æ ¹æ®ç”¨æˆ·åé¦ˆè‡ªåŠ¨è°ƒæ•´è§„åˆ™)
- [ ] æ·»åŠ ç‰¹æ®Šäº‹ä»¶ç³»ç»Ÿ (çºªå¿µæ—¥ã€ç”Ÿæ—¥ç­‰)

## ğŸ†˜ æ•…éšœæ’æŸ¥

### å¥½æ„Ÿåº¦ä¸æ›´æ–°
- æ£€æŸ¥ Redis è¿æ¥
- ç¡®è®¤ `dynamic_response_system` æ­£ç¡®å¯¼å…¥
- æŸ¥çœ‹æ—¥å¿— `chat_api` çš„è¾“å‡º

### å›å¤é£æ ¼ä¸å¯¹
- æ£€æŸ¥å½“å‰å¥½æ„Ÿåº¦åˆ†æ•°å’Œç­‰çº§
- ç¡®è®¤ `response_guidance` æ­£ç¡®ä¼ é€’ç»™ `generate_ai_response`
- æŸ¥çœ‹ `response_rules.py` é…ç½®æ˜¯å¦æ­£ç¡®

### ç­‰çº§è·³å˜è¿‡å¿«
- æ£€æŸ¥ä¿æŠ¤æœºåˆ¶æ˜¯å¦å¯ç”¨
- è°ƒæ•´ `SINGLE_ADJUSTMENT_LIMITS` çš„å€¼
- æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„å¤§é‡å¥½æ„Ÿåº¦å¢åŠ 

## ğŸ“„ è®¸å¯ä¸æ”¯æŒ

é›†æˆåˆ°ä½ çš„ AI-memory é¡¹ç›®ä¸­ï¼Œéµå¾ªé¡¹ç›®åŸæœ‰è®¸å¯è¯ã€‚

---

**ğŸ‰ ç³»ç»Ÿå·²å®Œå…¨é›†æˆå¹¶å¯ç«‹å³ä½¿ç”¨ï¼**

é€šè¿‡ç°æœ‰çš„ `/api/chat` ç«¯ç‚¹å‘é€æ¶ˆæ¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¥½æ„Ÿåº¦ã€æ£€æµ‹å†…å®¹ã€è°ƒæ•´å›å¤é£æ ¼ã€‚
